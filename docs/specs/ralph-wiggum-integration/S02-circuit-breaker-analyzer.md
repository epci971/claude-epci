# Specification — S02: Circuit Breaker & Response Analyzer

> **Parent project**: ralph-wiggum-integration
> **Spec ID**: S02
> **Estimated effort**: 3 day(s)
> **Dependencies**: -
> **Blocks**: S03, S04

---

## 1. Context

This sub-spec implements the core infrastructure for the Script mode (fresh context), based on the frankbria/ralph-claude-code library. These components ensure robust overnight execution by detecting stagnation and parsing Claude responses.

**Source**: `PRD-ralph-wiggum-integration-2025-01-13.md` — US9, US10, US11

---

## 2. Scope

### Included

- US9: Circuit Breaker Pattern
  - Three states: CLOSED, HALF_OPEN, OPEN
  - No-progress detection (3 loops without file changes)
  - Same-error detection (5 consecutive identical errors)
  - Configurable thresholds
  - Reset mechanism (--reset-circuit)

- US10: Response Analyzer
  - JSON output parsing
  - Text output parsing with RALPH_STATUS block
  - Stuck loop detection
  - Dual-condition exit evaluation (indicators + EXIT_SIGNAL)
  - Confidence scoring

- US11: RALPH_STATUS Block
  - Format definition and documentation
  - PROMPT.md template section for RALPH_STATUS
  - Validation of required fields

### Excluded

- Mode Hook — see S01
- Script generation — see S03
- Integration with /ralph command — see S04

---

## 3. Tasks

### Circuit Breaker (US9)

- [ ] Create `src/scripts/lib/circuit_breaker.sh`
  - [ ] Implement state machine (CLOSED/HALF_OPEN/OPEN)
  - [ ] Track no-progress counter (files_modified == 0)
  - [ ] Track same-error counter
  - [ ] Configurable thresholds (CB_NO_PROGRESS_THRESHOLD=3, CB_SAME_ERROR_THRESHOLD=5)
  - [ ] State persistence (.ralph-circuit-state.json)
  - [ ] Reset function
  - [ ] Logging and status reporting

### Response Analyzer (US10)

- [ ] Create `src/scripts/lib/response_analyzer.sh`
  - [ ] JSON parsing with jq
  - [ ] RALPH_STATUS block extraction (regex)
  - [ ] detect_stuck_loop() — compare last 3 outputs
  - [ ] should_exit() — dual-condition evaluation
  - [ ] confidence_score() — reliability assessment
  - [ ] Fallback to text heuristics if JSON malformed

### Date Utilities (Support)

- [ ] Create `src/scripts/lib/date_utils.sh`
  - [ ] Cross-platform date functions (macOS/Linux)
  - [ ] ISO 8601 formatting
  - [ ] Duration calculations

### RALPH_STATUS (US11)

- [ ] Document RALPH_STATUS format in templates
- [ ] Add RALPH_STATUS section to PROMPT.md template
- [ ] Validation function for required fields

### Tests

- [ ] Circuit breaker state transitions (BATS)
- [ ] Response analyzer JSON parsing
- [ ] Response analyzer text fallback
- [ ] RALPH_STATUS extraction
- [ ] Stuck loop detection

---

## 4. Acceptance Criteria

| ID | Criterion | Verification |
|----|-----------|--------------|
| S02-AC1 | 3 loops without file changes → HALF_OPEN state | Unit test |
| S02-AC2 | HALF_OPEN + still no progress → OPEN state | Unit test |
| S02-AC3 | OPEN state stops execution | Unit test |
| S02-AC4 | --reset-circuit returns to CLOSED | Unit test |
| S02-AC5 | 5 identical errors → OPEN state | Unit test |
| S02-AC6 | Progress in HALF_OPEN → back to CLOSED | Unit test |
| S02-AC7 | JSON output parsed correctly | Unit test |
| S02-AC8 | RALPH_STATUS block extracted from text | Unit test |
| S02-AC9 | Same error 3x → detect_stuck_loop returns true | Unit test |
| S02-AC10 | indicators >= 2 AND EXIT_SIGNAL=true → should_exit "project_complete" | Unit test |
| S02-AC11 | indicators >= 2 BUT EXIT_SIGNAL=false → continue | Unit test |
| S02-AC12 | RALPH_STATUS with all required fields validates | Unit test |

---

## 5. Technical Notes

### Circuit Breaker States

```
CLOSED (normal) ──[3 no-progress]──> HALF_OPEN (monitoring)
                                           │
                   ┌───[progress]──────────┘
                   │
                   v
              CLOSED ←── [no progress] ──> OPEN (stop)
```

### RALPH_STATUS Format

```
---RALPH_STATUS---
STATUS: IN_PROGRESS | COMPLETE | BLOCKED
TASKS_COMPLETED_THIS_LOOP: <number>
FILES_MODIFIED: <number>
TESTS_STATUS: PASSING | FAILING | NOT_RUN
WORK_TYPE: IMPLEMENTATION | TESTING | DOCUMENTATION | REFACTORING
EXIT_SIGNAL: false | true
RECOMMENDATION: <one line summary>
---END_RALPH_STATUS---
```

### Files to Create

| File | Type | Lines (est.) |
|------|------|--------------|
| `src/scripts/lib/circuit_breaker.sh` | Bash | ~200 |
| `src/scripts/lib/response_analyzer.sh` | Bash | ~250 |
| `src/scripts/lib/date_utils.sh` | Bash | ~80 |

### Dependencies

- `jq` — JSON parsing (must be installed)
- Bash 4.0+ — associative arrays

---

*Generated by /decompose — Project: ralph-wiggum-integration*
