# Specification — S04: Integration & Commande /ralph

> **Parent project**: ralph-wiggum-integration
> **Spec ID**: S04
> **Estimated effort**: 3 day(s)
> **Dependencies**: S01, S02, S03
> **Blocks**: S05

---

## 1. Context

This sub-spec implements the unified `/ralph` command and the `@ralph-executor` subagent that orchestrates story execution. It brings together both modes (hook and script) and integrates with existing EPCI commands (/brief, /quick, /epci).

**Source**: `PRD-ralph-wiggum-integration-2025-01-13.md` — US4, US5, US6

---

## 2. Scope

### Included

- US4: Subagent @ralph-executor
  - Story execution encapsulation
  - Integration with /brief for complexity assessment
  - Routing to /quick (TINY/SMALL) or /epci (STANDARD+)
  - Minimal Feature Document generation
  - Status reporting (pass/fail/blocked)

- US5: Commande /ralph
  - Unified entry point for both modes
  - --mode hook|script flag
  - --dry-run for plan preview
  - --max-iterations limit (required)
  - --overnight flag
  - prd.json directory detection

- US6: Mode hybride (context spec parent)
  - Load parent spec as context for each story
  - Targeted exploration based on spec scope
  - Context injection into /brief

### Excluded

- Mode Hook implementation — see S01 (already done)
- Mode Script implementation — see S02, S03 (already done)
- Security and polish — see S05

---

## 3. Tasks

### Subagent @ralph-executor (US4)

- [ ] Create `src/agents/ralph-executor.md`
  - [ ] Input: story object from prd.json
  - [ ] Load parent spec as context
  - [ ] Call /brief with story context
  - [ ] Route based on complexity:
    - TINY/SMALL → /quick --autonomous
    - STANDARD+ → /epci --autonomous
  - [ ] Generate minimal Feature Document
  - [ ] Return status: pass | fail | blocked
  - [ ] Update prd.json on completion

### Commande /ralph (US5)

- [ ] Create `src/commands/ralph.md`
  - [ ] Argument: specs directory path
  - [ ] Validate prd.json exists
  - [ ] --mode hook|script (auto-select if not specified)
  - [ ] --dry-run (show plan, no execution)
  - [ ] --max-iterations N (required)
  - [ ] --overnight (forces script mode)
  - [ ] --continue (resume from checkpoint)
  - [ ] --reset-circuit (reset Circuit Breaker)
  - [ ] Breakpoint before execution start
  - [ ] Progress display during execution

### Mode Hybride (US6)

- [ ] Implement spec context loading
  - [ ] Read parent_spec from story.context
  - [ ] Inject spec content into /brief prompt
  - [ ] Scope exploration to spec files

### Integration Tests

- [ ] /ralph dry-run mode
- [ ] @ralph-executor with mock story
- [ ] Mode selection logic
- [ ] Spec context injection

---

## 4. Acceptance Criteria

| ID | Criterion | Verification |
|----|-----------|--------------|
| S04-AC1 | @ralph-executor calls /brief with story context | Log inspection |
| S04-AC2 | TINY/SMALL complexity → /quick --autonomous | Routing test |
| S04-AC3 | STANDARD+ complexity → /epci --autonomous | Routing test |
| S04-AC4 | Execution generates minimal Feature Document | File check |
| S04-AC5 | /ralph with prd.json directory starts execution | Manual test |
| S04-AC6 | --dry-run shows plan without execution | Manual test |
| S04-AC7 | --max-iterations stops at limit | Manual test |
| S04-AC8 | Missing --max-iterations shows error | Manual test |
| S04-AC9 | Story US-005 from S02 loads S02.md as context | Log inspection |
| S04-AC10 | Exploration is scoped to spec files | Log inspection |

---

## 5. Technical Notes

### @ralph-executor Flow

```
Story Input (from prd.json)
       │
       v
Load Parent Spec (S0X.md)
       │
       v
Call /brief (with spec context)
       │
       v
┌──────┴──────┐
│  Complexity │
└──────┬──────┘
       │
  ┌────┴────┐
  v         v
TINY/     STANDARD+
SMALL
  │         │
  v         v
/quick    /epci
--autonomous
  │         │
  └────┬────┘
       v
Generate Feature Doc
       │
       v
Return status + Update prd.json
```

### Mode Selection Logic

```python
def select_mode(flags, stories, estimated_duration):
    if flags.mode:
        return flags.mode
    if flags.overnight:
        return "script"
    if len(stories) < 10 and estimated_duration < 2:  # hours
        return "hook"
    return "script"
```

### Files to Create

| File | Type | Lines (est.) |
|------|------|--------------|
| `src/commands/ralph.md` | Markdown | ~400 |
| `src/agents/ralph-executor.md` | Markdown | ~250 |

### Dependencies

- S01: Mode Hook (ralph-stop-hook.sh)
- S02: Circuit Breaker, Response Analyzer
- S03: prd.json, ralph.sh, PROMPT.md generation

---

*Generated by /decompose — Project: ralph-wiggum-integration*
