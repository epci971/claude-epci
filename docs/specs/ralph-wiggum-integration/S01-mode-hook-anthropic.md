# Specification — S01: Mode Hook (Anthropic)

> **Parent project**: ralph-wiggum-integration
> **Spec ID**: S01
> **Estimated effort**: 2 day(s)
> **Dependencies**: -
> **Blocks**: S04

---

## 1. Context

This sub-spec implements the Stop Hook mode for Ralph Wiggum, based on the official Anthropic approach. This mode preserves context between iterations (same Claude session) and is ideal for shorter sessions (<2h).

**Source**: `PRD-ralph-wiggum-integration-2025-01-13.md` — US13, US14

---

## 2. Scope

### Included

- US13: Mode Stop Hook (Same Session)
  - Stop hook script that intercepts Claude outputs
  - YAML frontmatter state file (`.claude/ralph-loop.local.md`)
  - `<promise>COMPLETE</promise>` completion detection
  - Prompt re-injection mechanism

- US14: Commande /cancel-ralph
  - Command to cancel active Ralph loop
  - State file cleanup
  - Confirmation message with stats

### Excluded

- Mode Script (fresh context) — see S02, S03
- Circuit Breaker pattern — see S02
- Response Analyzer — see S02
- Integration with /brief and /quick — see S04

---

## 3. Tasks

- [ ] Create `src/hooks/ralph-stop-hook.sh` (~150 lines)
  - [ ] Read JSONL transcript for output analysis
  - [ ] Detect `<promise>COMPLETE</promise>` tags
  - [ ] Check max_iterations limit
  - [ ] Re-inject prompt on non-completion
  - [ ] Update iteration counter in state file

- [ ] Create `src/templates/ralph/ralph-loop.local.md` template
  - [ ] YAML frontmatter structure (iteration, max_iterations, completion_promise)
  - [ ] Document format and usage

- [ ] Create `src/commands/cancel-ralph.md`
  - [ ] Check for active loop (state file exists)
  - [ ] Remove state file
  - [ ] Display confirmation with iteration count
  - [ ] Handle "no active loop" case

- [ ] Write tests for stop hook
  - [ ] Test completion detection
  - [ ] Test iteration limit
  - [ ] Test state file management

---

## 4. Acceptance Criteria

| ID | Criterion | Verification |
|----|-----------|--------------|
| S01-AC1 | `/ralph --mode hook` activates stop-hook.sh | Manual test |
| S01-AC2 | Hook blocks exit and re-injects prompt | Log inspection |
| S01-AC3 | State file contains valid YAML frontmatter | File validation |
| S01-AC4 | `<promise>COMPLETE</promise>` stops the loop | Manual test |
| S01-AC5 | max_iterations reached stops the loop | Manual test |
| S01-AC6 | `/cancel-ralph` removes state file | Command test |
| S01-AC7 | `/cancel-ralph` shows "no active loop" if none | Command test |

---

## 5. Technical Notes

### State File Format

```yaml
---
iteration: 1
max_iterations: 50
completion_promise: "COMPLETE"
---
[Original prompt here]
```

### Stop Hook Behavior

1. Hook intercepts Claude's attempt to exit
2. Reads JSONL transcript for last response
3. Checks for completion promise or max iterations
4. If not complete: increments iteration, re-injects prompt
5. If complete: allows exit, cleanup state file

### Files to Create

| File | Type | Lines (est.) |
|------|------|--------------|
| `src/hooks/ralph-stop-hook.sh` | Bash | ~150 |
| `src/templates/ralph/ralph-loop.local.md` | Markdown | ~30 |
| `src/commands/cancel-ralph.md` | Markdown | ~80 |

---

*Generated by /decompose — Project: ralph-wiggum-integration*
