# Specification — S05: Génération prd.json et templates

> **Parent project**: ralph-wiggum-integration
> **Spec ID**: S05
> **Estimated effort**: 3 day(s)
> **Dependencies**: S03
> **Blocks**: S06

---

## 1. Context

This sub-spec enriches the `/decompose` command to generate Ralph-compatible files: `prd.json` (stories), `ralph.sh` (launcher script), and `PROMPT.md` (intelligent prompt template). The `ralph-converter` skill handles the conversion from specs to stories.

**Source**: `PRD-ralph-wiggum-integration-2025-01-13.md` — US1, US2, US3

---

## 2. Scope

### Included

- `ralph-converter` skill for specs → prd.json conversion
- `--granularity` flag (micro/small/standard)
- `ralph.sh` launcher script generation
- `PROMPT.md` template with stack detection
- Integration with `/decompose` command
- Parent spec mapping in stories

### Excluded

- Circuit Breaker (S02)
- Response Analyzer (S03)
- ralph_loop.sh main script (S04)
- @ralph-executor subagent (S06)

---

## 3. Tasks

- [ ] Create `src/skills/core/ralph-converter/SKILL.md`
  - [ ] Define skill metadata (description, triggers)
  - [ ] Implement spec parsing logic
  - [ ] Implement granularity-based splitting:
    - [ ] micro: 15-30 min stories
    - [ ] small: 30-60 min stories
    - [ ] standard: 1-2h stories (default)
  - [ ] Map tasks from spec `## 3. Tasks` section to stories
  - [ ] Generate unique story IDs (US-001, US-002, etc.)
  - [ ] Set parent_spec field for context linking

- [ ] Update `src/commands/decompose.md`
  - [ ] Add `--granularity` flag documentation
  - [ ] Add Phase 4B: Ralph Generation (default, skip with --no-ralph)
  - [ ] Invoke ralph-converter skill
  - [ ] Generate all Ralph files in output directory

- [ ] Implement prd.json generation:
  - [ ] Schema: id, title, parent_spec, estimated_minutes, priority, passes
  - [ ] Order stories by parent spec, then by task order
  - [ ] Calculate estimated_minutes based on granularity
  - [ ] Set initial passes: false

- [ ] Implement ralph.sh generation:
  - [ ] Shebang and bash strict mode
  - [ ] Path to ralph_loop.sh
  - [ ] Default arguments (--max-iterations, prd path)
  - [ ] Make executable (chmod +x)
  - [ ] Documentation header

- [ ] Implement PROMPT.md stack detection:
  - [ ] Detect package.json → npm/pnpm commands
  - [ ] Detect composer.json → PHP/Composer commands
  - [ ] Detect requirements.txt → pip/python commands
  - [ ] Detect Cargo.toml → cargo commands
  - [ ] Mark "À PERSONNALISER" sections
  - [ ] Include RALPH_STATUS format (from S03)

- [ ] Write tests for ralph-converter skill

---

## 4. Acceptance Criteria

| ID | Criterion | Verification |
|----|-----------|--------------|
| S05-AC1 | Given PRD Markdown, When `/decompose` runs, Then prd.json generated with atomic stories | File generation test |
| S05-AC2 | Given `--granularity small`, When decomposition runs, Then each day generates 3-5 stories | Granularity test |
| S05-AC3 | Given `/decompose` completes, Then ralph.sh is generated and executable | Script generation test |
| S05-AC4 | Given project with package.json, When PROMPT.md generated, Then npm/pnpm commands pre-filled | Stack detection test |
| S05-AC5 | Given project with composer.json, When PROMPT.md generated, Then PHP commands pre-filled | Stack detection test |
| S05-AC6 | Given PROMPT.md generated, When opened, Then "À PERSONNALISER" sections clearly marked | Template test |
| S05-AC7 | Given story in prd.json, When inspected, Then parent_spec field references source spec | Parent mapping test |

---

## 5. Technical Notes

### prd.json Schema

```json
{
  "project": "ralph-wiggum-integration",
  "generated": "2025-01-13T10:00:00Z",
  "granularity": "standard",
  "stories": [
    {
      "id": "US-001",
      "title": "Implement cb_init function",
      "parent_spec": "S02-circuit-breaker.md",
      "estimated_minutes": 90,
      "priority": 1,
      "passes": false
    },
    {
      "id": "US-002",
      "title": "Implement cb_get_state function",
      "parent_spec": "S02-circuit-breaker.md",
      "estimated_minutes": 60,
      "priority": 1,
      "passes": false
    }
  ]
}
```

### Granularity Mapping

| Granularity | Minutes/Story | Stories/Day |
|-------------|---------------|-------------|
| micro | 15-30 | 16-32 |
| small | 30-60 | 8-16 |
| standard | 60-120 | 4-8 |

### ralph.sh Template

```bash
#!/usr/bin/env bash
# Ralph Wiggum Launcher
# Generated by /decompose for: ralph-wiggum-integration
# Usage: ./ralph.sh [--continue] [--dry-run]

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
RALPH_LOOP="${SCRIPT_DIR}/../../src/scripts/ralph_loop.sh"

exec "$RALPH_LOOP" \
    --prd "${SCRIPT_DIR}/prd.json" \
    --max-iterations 50 \
    "$@"
```

### Stack Detection Rules

| File | Stack | Commands |
|------|-------|----------|
| package.json | Node.js | npm test, npm run build |
| composer.json | PHP | composer test, php artisan |
| requirements.txt | Python | pytest, python manage.py |
| Cargo.toml | Rust | cargo test, cargo build |
| pom.xml | Java | mvn test, mvn package |

---

## 6. Source Reference

> Extract from `PRD-ralph-wiggum-integration-2025-01-13.md`

**US1 — Générer prd.json depuis /decompose**

- Given un PRD Markdown, When je lance `/decompose`, Then un fichier prd.json est généré avec les stories atomiques
- Given le flag `--granularity small`, When la décomposition s'exécute, Then chaque jour de travail génère 3-5 stories
- Given la génération termine, Then ralph.sh et PROMPT.md sont aussi générés

**US2 — Script ralph.sh généré**

- Given la génération, When elle termine, Then ralph.sh est exécutable
- Given ralph.sh, When je le lance, Then il boucle sur les stories passes=false
- Given une story complétée, When le commit est fait, Then prd.json est mis à jour avec passes=true

**US3 — prompt.md intelligent**

- Given un projet avec package.json, When PROMPT.md est généré, Then les commandes npm/pnpm sont pré-remplies
- Given un projet avec composer.json, When PROMPT.md est généré, Then les commandes PHP sont pré-remplies
- Given PROMPT.md généré, When je l'ouvre, Then des sections "À PERSONNALISER" sont clairement marquées

---

*Generated by /decompose — Project: ralph-wiggum-integration*
