# Specification — S01: Mode Hook Anthropic

> **Parent project**: ralph-wiggum-integration
> **Spec ID**: S01
> **Estimated effort**: 2 day(s)
> **Dependencies**: —
> **Blocks**: S06

---

## 1. Context

This sub-spec implements the **Stop Hook mode** for Ralph, based on Anthropic's official implementation. This mode keeps the same Claude session context between iterations, making it ideal for shorter sessions (<2h).

**Source**: `PRD-ralph-wiggum-integration-2025-01-13.md` — US13, US14

---

## 2. Scope

### Included

- Stop hook shell script (`ralph-stop-hook.sh`)
- State file template with YAML frontmatter (`ralph-loop.local.md`)
- `/cancel-ralph` command to abort running loops
- Completion detection via `<promise>COMPLETE</promise>` tags
- Integration with Claude Code hook system

### Excluded

- Circuit Breaker pattern (S02)
- Response Analyzer (S03)
- Fresh context mode (S04)
- Rate limiting (S08)

---

## 3. Tasks

- [ ] Create `src/hooks/ralph-stop-hook.sh` (~150 lines)
  - [ ] Implement hook registration with Claude Code
  - [ ] Read state from `.claude/ralph-loop.local.md`
  - [ ] Parse YAML frontmatter (iteration, max_iterations, completion_promise)
  - [ ] Detect `<promise>COMPLETE</promise>` in output
  - [ ] Increment iteration counter on each loop
  - [ ] Block exit and reinject prompt if not complete
  - [ ] Allow exit when max_iterations reached or promise detected

- [ ] Create `src/templates/ralph/ralph-loop.local.md`
  - [ ] YAML frontmatter schema (iteration, max_iterations, completion_promise)
  - [ ] Placeholder for original prompt
  - [ ] Documentation comments

- [ ] Create `src/commands/cancel-ralph.md`
  - [ ] Check for active Ralph session (`.claude/ralph-loop.local.md` exists)
  - [ ] Delete state file to stop loop
  - [ ] Display stats (iterations completed)
  - [ ] Handle "no active session" case gracefully

- [ ] Update `src/hooks/README.md` with ralph-stop-hook documentation

- [ ] Write tests for stop hook behavior

---

## 4. Acceptance Criteria

| ID | Criterion | Verification |
|----|-----------|--------------|
| S01-AC1 | Given `/ralph --mode hook`, When launched, Then stop-hook.sh is activated | Manual test |
| S01-AC2 | Given an iteration in progress, When Claude attempts to exit, Then hook blocks and reinjects prompt | Hook integration test |
| S01-AC3 | Given `.claude/ralph-loop.local.md` created, When inspected, Then YAML frontmatter is valid | Schema validation |
| S01-AC4 | Given `<promise>COMPLETE</promise>` in output, When detected, Then loop stops cleanly | Output parsing test |
| S01-AC5 | Given max_iterations reached, When checked by hook, Then loop stops with message | Iteration counter test |
| S01-AC6 | Given active Ralph loop, When `/cancel-ralph` executed, Then state file deleted | Command test |
| S01-AC7 | Given no active loop, When `/cancel-ralph` executed, Then "No active Ralph loop" message | Edge case test |

---

## 5. Technical Notes

### State File Format

```yaml
---
iteration: 1
max_iterations: 50
completion_promise: "COMPLETE"
---
[Original prompt content here]
```

### Hook Behavior Flow

```
Claude output → stop-hook.sh intercepts
    ↓
Check for <promise>COMPLETE</promise>
    ↓
If found → Allow exit
If not found:
    ↓
Check iteration < max_iterations
    ↓
If true → Increment counter, reinject prompt
If false → Allow exit with "max iterations" message
```

### Files Reference

Based on Anthropic official implementation:
- `hooks/stop-hook.sh` — Main hook (~150 lines)
- `commands/ralph-loop.md` — Loop command
- `commands/cancel-ralph.md` — Cancel command

---

## 6. Source Reference

> Extract from `PRD-ralph-wiggum-integration-2025-01-13.md`

**US13 — Mode Stop Hook (Same Session)**

- Given `/ralph --mode hook`, When lancé, Then le stop-hook.sh est activé et intercepte les sorties
- Given une itération en cours, When Claude tente de sortir, Then le hook bloque et réinjecte le prompt
- Given fichier `.claude/ralph-loop.local.md`, When créé, Then il contient le frontmatter YAML
- Given `<promise>COMPLETE</promise>` dans la sortie, When détecté, Then la boucle s'arrête

**US14 — Commande /cancel-ralph**

- Given une boucle Ralph active, When `/cancel-ralph` est exécuté, Then le fichier d'état est supprimé
- Given pas de boucle active, When `/cancel-ralph` est exécuté, Then message "Aucune boucle Ralph active"

---

*Generated by /decompose — Project: ralph-wiggum-integration*
