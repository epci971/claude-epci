# Step 08: Generate

> Write brief and journal files to disk.

## Trigger

- Previous step: `step-07-validate.md` completed
- Or: `--quick` mode skipped validation

## Inputs

| Input | Source | Required |
|-------|--------|----------|
| `brief_final` | From step-07 (or brief_v0 if quick) | Yes |
| `ems` | Session state | Yes |
| `decisions[]` | Session state | Yes |
| `open_threads[]` | Session state | No |
| `techniques_applied` | Session state | No |
| `edit_history` | From step-07 | No |
| `security_audit` | From step-06 | No |
| `--quick` flag | From step-00 | No |

## Protocol

### 1. Generate Slug and Paths

```python
slug = slugify(idea_refined)  # e.g., "auth-oauth-integration"
date = datetime.now().strftime("%Y%m%d")

output_dir = f"docs/briefs/{slug}/"
brief_path = f"{output_dir}brief-{slug}-{date}.md"
journal_path = f"{output_dir}journal-{slug}-{date}.md"
```

### 2. Create Output Directory

```bash
mkdir -p docs/briefs/{slug}/
```

### 3. Generate Brief (PRD v3.0 Format)

Using template from `references/brief-format.md`:

```markdown
---
title: {idea_refined}
slug: {slug}
version: 1.0
date: {date}
ems_score: {ems.global}
complexity: {complexity_estimate}
status: draft
---

# {Title}

## Executive Summary
{summary from validated brief}

## Problem Statement
{problem from validated brief}

## Proposed Solution
{solution from validated brief}

## Scope

### In Scope
- {item_1}
- {item_2}

### Out of Scope
- {item_1}
- {item_2}

## Requirements

### Functional Requirements
| ID | Requirement | Priority |
|----|-------------|----------|
| FR-01 | {requirement} | {HIGH|MEDIUM|LOW} |

### Non-Functional Requirements
| ID | Requirement | Category |
|----|-------------|----------|
| NFR-01 | {requirement} | {Performance|Security|...} |

## Constraints
{constraints from validated brief}

## Success Criteria
- [ ] {criterion_1}
- [ ] {criterion_2}

## Implementation Notes

### Complexity
- **Estimate**: {complexity_estimate}
- **Routing**: {/implement|/quick}

### Security Considerations
{security_audit.recommendations if available}

### Open Threads
{open_threads if any}

## Appendix

### HMW Questions Explored
{hmw_questions}

### Key Decisions
{decisions list}

---
Generated by /brainstorm | EMS: {ems.global}/100 | {date}
```

### 4. Write Brief File

```python
Write(brief_path, brief_content)
```

### 5. Generate Journal (unless --quick)

Using template from `references/journal-format.md`:

```markdown
---
title: Exploration Journal - {idea_refined}
session_id: {session_id}
date: {date}
iterations: {count}
final_ems: {ems.global}
---

# Exploration Journal

## Session Overview
- **Start**: {start_time}
- **End**: {end_time}
- **Duration**: {duration_minutes} minutes
- **Iterations**: {count}
- **Final EMS**: {ems.global}/100

## EMS Progression

| Iteration | EMS | Delta | Phase | Persona |
|-----------|-----|-------|-------|---------|
| 0 | {init} | - | INIT | - |
| 1 | {score} | +{delta} | DIVERGENT | architecte |
| 2 | {score} | +{delta} | DIVERGENT | maieuticien |
| ... | ... | ... | ... | ... |

## Iteration Details

### Iteration 1
**Phase**: DIVERGENT | **Persona**: architecte | **EMS**: {score}

**Questions Asked**:
1. {question_1}
2. {question_2}

**User Responses**:
- {response_summary}

**Insights Gained**:
- {insight_1}

**Decisions Made**:
- {decision if any}

---

### Iteration 2
...

## Techniques Applied
| Technique | Iteration | Target Axis | Impact |
|-----------|-----------|-------------|--------|
| {technique} | {iter} | {axis} | +{delta} EMS |

## Persona Switches
| From | To | Iteration | Trigger |
|------|-----|-----------|---------|
| architecte | sparring | 3 | "obviously" detected |

## Phase Transitions
- DIVERGENT (iter 1-4)
- CONVERGENT (iter 5-7)

## Validation History
{edit_history if any}

## Final State
```json
{
  "ems": {...},
  "decisions": [...],
  "open_threads": [...]
}
```

---
Journal generated by /brainstorm | {date}
```

### 6. Write Journal File (unless --quick)

```python
IF NOT --quick:
  Write(journal_path, journal_content)
```

### 7. Update Session State

```json
{
  "generation_complete": true,
  "output_files": [
    "{brief_path}",
    "{journal_path}"  // null if --quick
  ],
  "slug": "{slug}"
}
```

## Outputs

| Output | Destination |
|--------|-------------|
| `brief-{slug}-{date}.md` | `docs/briefs/{slug}/` |
| `journal-{slug}-{date}.md` | `docs/briefs/{slug}/` (unless --quick) |
| `generation_complete` | Session state |
| `output_files` | Session state |

## Next Step

â†’ `step-09-report.md`

## Error Handling

| Error | Resolution |
|-------|------------|
| Directory creation fails | Try alternative path |
| Write permission denied | Warn user, output to console |
| File already exists | Add suffix (-v2, -v3) |
