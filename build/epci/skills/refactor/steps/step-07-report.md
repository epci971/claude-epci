# Step 07: Report

> Generate final metrics report, update project-memory, suggest next steps.

## Trigger

- Previous step: `step-06-verify.md` completed

## Inputs

| Input | Source |
|-------|--------|
| All state data | From previous steps |
| Metrics delta | From step-06 |
| Review results | From step-05 (if done) |

## Protocol

### 1. Generate Metrics Report

Use template from [templates/metrics-report.md](../templates/metrics-report.md):

```markdown
# Refactoring Report

> Generated: {timestamp}
> Target: {target}
> Scope: {scope}

## Summary

| Metric | Before | After | Delta | Trend |
|--------|--------|-------|-------|-------|
| Lines of Code | {loc_before} | {loc_after} | {loc_delta} | {trend} |
| Cyclomatic Complexity (avg) | {cc_before} | {cc_after} | {cc_delta} | {trend} |
| Maintainability Index (avg) | {mi_before} | {mi_after} | {mi_delta} | {trend} |

## Transformations Applied

| # | Pattern | Description | Status |
|---|---------|-------------|--------|
{foreach transformation}
| {id} | {pattern} | {description} | {status} |
{/foreach}

## Files Changed

### Modified
{foreach modified_file}
- `{path}` - {change_description}
{/foreach}

### Created
{foreach created_file}
- `{path}` - {purpose}
{/foreach}

### Deleted
{foreach deleted_file}
- `{path}` - {reason}
{/foreach}

## Code Smells Resolved

| Smell | Location | Resolution |
|-------|----------|------------|
{foreach smell_resolved}
| {smell_type} | {location} | {how_resolved} |
{/foreach}

## Detailed Metrics by File

{foreach file in affected_files}
### {file.path}

| Metric | Before | After | Delta |
|--------|--------|-------|-------|
| LOC | {file.loc_before} | {file.loc_after} | {file.loc_delta} |
| CC | {file.cc_before} | {file.cc_after} | {file.cc_delta} |
| MI | {file.mi_before} | {file.mi_after} | {file.mi_delta} |
{/foreach}

## Test Results

- **Total Tests**: {test_count}
- **Passing**: {passing_count}
- **Coverage**: {coverage}%

## Reviews (if applicable)

{if reviews_done}
| Reviewer | Status | Key Findings |
|----------|--------|--------------|
{foreach review}
| {reviewer} | {status} | {summary} |
{/foreach}
{/if}

---
*Report generated by /refactor skill - EPCI v6.0*
```

### 2. Update Project Memory

Store refactoring pattern for future reference:

```python
project_memory.store_refactoring({
    "id": refactor_id,
    "timestamp": now(),
    "target": target,
    "scope": scope,
    "patterns_applied": [t.pattern for t in transformations],
    "metrics_improvement": {
        "loc_delta_percent": delta.loc.percent,
        "cc_delta_percent": delta.cc.percent,
        "mi_delta_percent": delta.mi.percent
    },
    "code_smells_resolved": smells_resolved,
    "files_affected": modified_files,
    "duration_seconds": duration,
    "success": True
})
```

### 3. Display Final Summary

```
## Refactoring Complete

**Target**: src/services/auth.py
**Scope**: module
**Duration**: 4m 32s

### Metrics Improvement

```
BEFORE                          AFTER
┌─────────────────┐            ┌─────────────────┐
│ LOC: 450        │     →      │ LOC: 365 (-19%) │
│ CC: 25          │     →      │ CC: 8.5 (-66%)  │
│ MI: 45          │     →      │ MI: 71.5 (+59%) │
└─────────────────┘            └─────────────────┘
```

### Code Smells
- Resolved: 4 (Long Method x2, Feature Envy, Deep Nesting)
- Remaining: 0

### Files
- Modified: 3
- Created: 2
- Deleted: 0

### Tests
- Status: ALL PASSING
- Count: 124 tests
- Coverage: 85%
```

### 4. Suggest Next Steps

```
## Next Steps

### Recommended
1. **Commit changes**: `/commit` - Ready to commit refactoring
2. **Create PR**: Changes ready for review

### Optional
3. **Continue refactoring**: Other files with similar patterns detected
   - `src/services/user.py` - Similar code smells
   - `src/services/session.py` - High complexity

### Report Location
Full metrics report saved to:
`.claude/reports/refactor-auth-{timestamp}.md`
```

### 5. Offer Commit (if not --atomic)

```
## Ready to Commit?

All transformations complete and tests passing.

[A] Create commit with standard message
[B] Create commit with custom message
[C] Skip commit (I'll do it manually)
```

If user chooses A:

```bash
git add <all_modified_files>
git commit -m "refactor(services): restructure auth.py for improved maintainability

- Extract validate_credentials() method
- Create TokenValidator class
- Move user lookups to user.py
- Remove dead code

Metrics:
- CC: 25 → 8.5 (-66%)
- MI: 45 → 71.5 (+59%)

Co-Authored-By: Claude <noreply@anthropic.com>"
```

## Outputs

| Output | Destination |
|--------|-------------|
| Metrics report | `.claude/reports/refactor-{slug}-{timestamp}.md` |
| Project memory entry | `project-memory` storage |
| Final summary | User display |
| Git commit (optional) | Repository |

## Next Step

→ END (skill complete)

## Error Handling

| Error | Resolution |
|-------|------------|
| Report write fails | Display in console instead |
| Memory update fails | Log warning, continue |
| Commit fails | Provide manual instructions |
